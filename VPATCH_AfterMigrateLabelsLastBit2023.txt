ALTER TABLE SETUP
ADD
	SEARCHBYBARCODE BIT NULL DEFAULT 0
GO

UPDATE SETUP SET SEARCHBYBARCODE = 0 WHERE SEARCHBYBARCODE IS NULL
GO

ALTER TABLE SETUP
ADD
	SALERXB4DAYEND BIT NULL DEFAULT 0
GO

UPDATE SETUP SET SALERXB4DAYEND = 0 WHERE SALERXB4DAYEND IS NULL
GO

CREATE TABLE [dbo].[EXPENSEJOURNALS](
	[EXPENSEJOURNALID] [BIGINT] NOT NULL,
	[EXPENSEJOURNALLINENO] [BIGINT] NOT NULL,
	[SUPPLIERCODE] [int] NULL default 0,
	[EXPENSETYPEID] [int] NOT NULL,
	[DESCRIPTION] NVARCHAR(60) NULL,
	[AMOUNT] [money] NULL default 0,
	[EFFECTIVEDATE] [date] NULL,
	[USERID] [int] NULL default 0,
	[AUTHORIZEDBY] [int] NULL default 0,
	[TIMETRANS] [datetime] NULL,
	CONSTRAINT [PK_EXPENSEJOURNALS] PRIMARY KEY(EXPENSEJOURNALID, EXPENSEJOURNALLINENO)
)
GO

DROP PROCEDURE [dbo].[PROC_VIEWGROSSPROFIT]
GO

CREATE PROCEDURE [dbo].[PROC_VIEWGROSSPROFIT]( @FROM DATE, @TO DATE)
AS
SELECT 2 AS REPORTID, SUM(ROUND((S.STARTQTY /S.PACKSIZE * S.STARTCOST),2)) AS OPENINGSTOCK, 0 AS CLOSINGSTOCK , 0 AS PURCHASES, 0 AS SALES, '' AS EXPENSETYPENAME, 0 AS EXPENSEAMOUNT
FROM TEMP_STOCKMOVEMENTS S WHERE S.PACKSIZE > 0 AND S.PRODUCTCODE > 11 GROUP BY S.BRANCHNO

UNION SELECT 4 AS REPORTID, 0 AS OPENINGSTOCK, SUM(ROUND((S.ENDQTY / S.PACKSIZE * S.ENDCOST),2)) AS CLOSINGSTOCK , 0 AS PURCHASES, 0 AS SALES, '' AS EXPENSETYPENAME, 0 AS EXPENSEAMOUNT
FROM TEMP_STOCKMOVEMENTS S WHERE S.PACKSIZE > 0 AND S.PRODUCTCODE > 11 GROUP BY S.BRANCHNO

UNION SELECT 1 as REPORTID, 0 AS OPENINGSTOCK, 0 AS CLOSINGSTOCK, 0 AS PURCHASES, SUM(T.LINETOTAL - T.ACC_PAYMENT - T.DISCOUNTAMOUNT) AS SALES, '' AS EXPENSETYPENAME, 0 AS EXPENSEAMOUNT FROM TRANSACTIONS T
WHERE CONVERT(DATE, T.TIMETRANS) >= @FROM AND CONVERT(DATE,T.TIMETRANS) <= @TO AND TRANTYPE IN (SELECT TRANTYPE FROM TRANTYPE WHERE CATEGORYID = 1 OR CATEGORYID=2)
GROUP BY T.BRANCHNO

UNION SELECT 3 AS REPORTID, 0 AS OPENINGSTOCK, 0 AS CLOSINGSTOCK,  SUM(T.LINETOTAL - T.ACC_PAYMENT - T.DISCOUNTAMOUNT) AS PURCHASES, 0 AS SALES, '' AS EXPENSETYPENAME, 0 AS EXPENSEAMOUNT FROM TRANSACTIONS T
WHERE CONVERT(DATE, T.TIMETRANS) >= @FROM AND CONVERT(DATE, T.TIMETRANS) <= @TO AND TRANTYPE IN (SELECT TRANTYPE FROM TRANTYPE WHERE CATEGORYID IN (3,4, 8,9))
GROUP BY T.BRANCHNO

UNION SELECT 5 AS REPORTID, 0 AS OPENINGSTOCK, 0 AS CLOSINGSTOCK, 0 AS PURCHASES, 0 AS SALES, ET.EXPENSETYPENAME, SUM(E.AMOUNT) AS EXPENSEAMOUNT FROM EXPENSEJOURNALS E INNER JOIN EXPENSETYPES ET ON E.EXPENSETYPEID = ET.EXPENSETYPEID
WHERE CONVERT(DATE, E.EFFECTIVEDATE) >= @FROM AND CONVERT(DATE, E.EFFECTIVEDATE) <= @TO GROUP BY E.EXPENSETYPEID, ET.EXPENSETYPENAME

GO






ALTER TABLE CONTROLS 
ADD
	NEXTEXPENSEJOURNALID BIGINT NULL DEFAULT 0
GO
UPDATE CONTROLS SET NEXTEXPENSEJOURNALID = 1 WHERE NEXTEXPENSEJOURNALID IS NULL
GO

INSERT INTO [RETAIL].[dbo].[POS_SYSTEMMODULES] ([MODULEID] ,[MODULENAME] ,[FORMNAME] ,[MENUNAME] ,[FRIENDINDEX] ,[HELPCONTEXTID], [USERID] ,[TIMETRANS])
     VALUES('96','Expense Register','Expense Register', 'mnuBusinessExpenses','1','1','1',getdate())

CREATE TABLE [dbo].[EXPENSETYPES](
	[EXPENSETYPEID] [int] NOT NULL,
	[EXPENSETYPENAME] [nvarchar](60) NULL,
	[USERID] [int] NULL,
	[TIMETRANS] [datetime] NULL,
 CONSTRAINT [PK_EXPENSETYPES] PRIMARY KEy([EXPENSETYPEID]) )
go
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('1', 'Rent', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('2', 'Electricity', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('3', 'Water & Rates', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('4', 'Sundry', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('5', 'Fuel', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('6', 'Booked Accomodation', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('7', 'Transport', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('8', 'Stationery & Printing', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('9', 'Salaries', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('10', 'Security', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('11', 'Systems &  IT', 0, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('12', 'Accounting', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('13', 'Cleaning', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('14', 'Taxes', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('15', 'Internet', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('16', 'Telephone', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('17', 'Advertising', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('18', 'Donations', 1,'16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('19', 'Training', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('20', 'Office Groceries', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('21', 'Motor Vehicle Expenses', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('22', 'Insurance', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('23', 'Computers-Hardware', 1, '16-Sep-2022')
INSERT into [dbo].[EXPENSETYPES] ([EXPENSETYPEID], [EXPENSETYPENAME], [USERID], [TIMETRANS]) VALUES ('24', 'Medical Expenses', 1, '16-Sep-2022')
GO

ALTER TABLE STOCKCYCLECOUNT
ADD
	DISCONFIRMEDBY INT NULL DEFAULT 0
GO
UPDATE 	STOCKCYCLECOUNT SET DISCONFIRMEDBY = 0 WHERE DISCONFIRMEDBY IS NULL
GO

ALTER TABLE TRANSACTIONS
ADD
	DISCONFIRMEDBY INT NULL DEFAULT 0
GO
UPDATE 	TRANSACTIONS SET DISCONFIRMEDBY = 0 WHERE DISCONFIRMEDBY IS NULL
GO

USE [RETAIL]
GO
USE [RETAIL]
GO

ALTER TABLE DEBTORS
ADD
	DEFAULTTENDERTYPE INT NULL DEFAULT 5	
GO

UPDATE DEBTORS SET DEFAULTTENDERTYPE = 5 WHERE DEFAULTTENDERTYPE IS NULL
GO

/****** Object:  View [dbo].[VIEW_ALLTRANSACTIONS]    Script Date: 04/19/2023 22:50:09 ******/
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VIEW_ALLTRANSACTIONS]'))
DROP VIEW [dbo].[VIEW_ALLTRANSACTIONS]
GO

USE [RETAIL]
GO

/****** Object:  View [dbo].[VIEW_ALLTRANSACTIONS]    Script Date: 04/19/2023 22:50:09 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

DROP VIEW [dbo].[VIEW_ALLTRANSACTIONS]
GO

USE [RETAIL]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

DROP VIEW [dbo].[VIEW_ALLTRANSACTIONS]
GO

CREATE VIEW [dbo].[VIEW_ALLTRANSACTIONS]
AS
SELECT     TI.BRANCHNO, TT.TRANSNO, TI.TILLNO, TI.ACCOUNTID, 1 AS PRODUCTCODE, 1 AS PACKSIZE, 1 AS QUANTITY, TT.TENDERTYPE AS TRANTYPE, TT.TENDERTYPE AS TENDER_TYPEID, 
                      TP.TENDERTYPE AS TENDERNAME, 0 AS COSTINFOREX, 0 AS COSTPRICE, 0 AS PRICEB4TAX, 0 AS SELLINGPRICE, TT.TRANSTOTAL, 0 AS ACC_PAYMENT, TT.DISCOUNTFACTOR, 
                      TT.DISCOUNT AS DISCOUNTAMOUNT, TT.AMOUNTTENDERED, TT.TENDEREXCHANGE, 1 AS BASECURRENCYRATE, TT.CHANGEAMOUNT, TT.TIMETRANS, 1 AS REPORTORDER, 
                      0 AS QUANTITYFREE
FROM         TRANSACTIONTOTALS TT INNER JOIN
                      VIEW_TRANSACTIONSINDEX TI ON TT.TRANSNO = TI.TRANSNO INNER JOIN
                      TRANTYPE TP ON TT.TENDERTYPE = TP.TRANTYPE
WHERE     TI.TRANTYPE not in (15, 20, 22) AND TT.TENDERTYPE IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, T.ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      1 AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T.TRANTYPE = TP.TRANTYPE 
WHERE     T .TRANTYPE IN (15)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      S.TENDEREXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE INNER JOIN
                      SCRIPTHEADERS S ON T .SCRIPTNO = S.SCRIPTNO
WHERE     T .TRANTYPE = 22

UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, T.ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, D.DEFAULTTENDERTYPE AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T.ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      1 AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 1 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T.TRANTYPE = TP.TRANTYPE INNER JOIN DEBTORS D ON T.ACCOUNTID = D.ACCOUNTID
WHERE     T.TRANTYPE = 10 AND T.ACCOUNTID <> 0

UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      T .FOREXEXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE
WHERE     T .TRANTYPE NOT IN (15, 22, 10) AND T .TRANTYPE NOT IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)




GO

USE [RETAIL]
GO
DROP VIEW VIEW_REORDERLEVELS
GO

CREATE VIEW dbo.VIEW_REORDERLEVELS
AS
SELECT DISTINCT S.PRODUCTCODE, S.PACKSIZE, P.PRODUCTNAME, P.FORMCODE, P.STRENGTH, P.REORDERQUANTITY, S.SUPPLIERCOST, S.QUANTITY, P.REORDERLEVEL
FROM   dbo.PRODUCTS AS P INNER JOIN
             dbo.STOCKMAST AS S ON P.PRODUCTCODE = S.PRODUCTCODE
WHERE S.QUANTITY <= P.REORDERLEVEL and P.REORDERLEVEL > 0 AND P.DISCONTINUEDON IS NULL
GO


ALTER TABLE SETUP
ADD
	BlockAccountPayments BIT NULL DEFAULT 0,
	AutoPickMedAidAccount bit null default 0
GO
UPDATE SETUP SET BlockAccountPayments = 0 WHERE BlockAccountPayments IS NULL
GO
UPDATE SETUP SET AutoPickMedAidAccount = 0 WHERE AutoPickMedAidAccount IS NULL
GO

ALTER TABLE STOCKMAST
ADD
	QTYB4SYNCH MONEY NULL DEFAULT 0,
	SYNCHQUANTITY MONEY NULL DEFAULT 0
GO


DROP VIEW VIEW_SYSTEMUSERACTIVITYLOG
GO

CREATE VIEW VIEW_SYSTEMUSERACTIVITYLOG
AS 

SELECT U.FULLNAME, T.TRANSNO, T.TIMETRANS, T.TTIME, TC.CATEGORYNAME AS [DESCRIPTION], SUM(T.LINETOTAL)AS LINETOTAL,
0 AS OLDSELLING, 0 AS NEWSELLING
FROM TRANSACTIONS T INNER JOIN TRANTYPE TT ON T.TRANTYPE = TT.TRANTYPE INNER JOIN
TRANCATEGORY TC ON TT.CATEGORYID = TC.CATEGORYID  INNER JOIN 
SYSTEMUSERS U ON T.USERID = U.USERID 
WHERE TT.CATEGORYID = 1
GROUP BY T.TRANSNO, U.FULLNAME, TC.CATEGORYNAME, T.TIMETRANS, T.TTIME, TC.CATEGORYNAME 

UNION SELECT U.FULLNAME, T.TRANSNO, T.TIMETRANS, T.TTIME, TT.[DESCRIPTION], SUM(T.ACC_PAYMENT) AS LINETOTAL,
0 AS OLDSELLING, 0 AS NEWSELLING
FROM TRANSACTIONS T INNER JOIN TRANTYPE TT ON T.TRANTYPE = TT.TRANTYPE INNER JOIN
TRANCATEGORY TC ON TT.CATEGORYID = TC.CATEGORYID  INNER JOIN 
SYSTEMUSERS U ON T.USERID = U.USERID 
WHERE TT.CATEGORYID IN (2, 4, 5, 6, 7, 9, 10, 12)
GROUP BY T.TRANSNO, U.FULLNAME, TT.[DESCRIPTION], T.TIMETRANS, T.TTIME, TC.CATEGORYNAME 

UNION SELECT U.FULLNAME, T.TRANSNO, T.TIMETRANS,  T.TTIME, TT.[DESCRIPTION], SUM(T.LINETOTAL) AS LINETOTAL,
0 AS OLDSELLING, 0 AS NEWSELLING
FROM TRANSACTIONS T INNER JOIN TRANTYPE TT ON T.TRANTYPE = TT.TRANTYPE INNER JOIN
TRANCATEGORY TC ON TT.CATEGORYID = TC.CATEGORYID  INNER JOIN 
SYSTEMUSERS U ON T.USERID = U.USERID 
WHERE TT.CATEGORYID IN (3,8, 11)
GROUP BY T.TRANSNO, U.FULLNAME, TT.[DESCRIPTION], T.TIMETRANS, T.TTIME, TC.CATEGORYNAME 

UNION SELECT U.FULLNAME, H.HISTORYID TRANSNO, H.TIMETRANS, H.TIMETRANS TTIME, 'Price Change' as [DESCRIPTION],
0 AS LINETOTAL, H.OLDSELLING, H.NEWSELLING FROM PRICEHISTORY H INNER JOIN SYSTEMUSERS U ON H.USERID = U.USERID
WHERE NOT H.NEWSELLING IS NULL

UNION SELECT U.FULLNAME, O.OVERIDEID TRANSNO, O.TIMETRANS, O.TIMETRANS TTIME, 'Price Override' as [DESCRIPTION],
0 AS LINETOTAL, O.SELLINGPRICE, O.CHANGEDTO AS NEWSELLING 
FROM PRICEOVERRIDES O INNER JOIN SYSTEMUSERS U ON O.USERID = U.USERID
GO

ALTER TABLE SETUP
ADD
	AUTHORIZESCRIPTREPRINT BIT NULL DEFAULT 0
GO

UPDATE SETUP SET AUTHORIZESCRIPTREPRINT = 0 WHERE AUTHORIZESCRIPTREPRINT IS NULL
GO

ALTER TABLE QUOTATIONS
ADD
	COSTPRICE MONEY NULL DEFAULT 0
	
GO

UPDATE QUOTATIONS SET COSTPRICE = ROUND((SELLINGPRICE *2/3),2) WHERE COSTPRICE IS NULL
GO

ALTER TABLE QUOTATIONS
ADD
	SALESTRANSNO BIGINT NULL DEFAULT 0
	
GO

UPDATE QUOTATIONS SET SALESTRANSNO = 0 WHERE SALESTRANSNO IS NULL
GO

DROP VIEW VIEW_QUOTATIONNAMES

GO

CREATE VIEW VIEW_QUOTATIONNAMES
AS
SELECT     QUOTATIONID, CUSTOMERNAME, CUSTOMERSTREET, CUSTOMERAREA, CUSTOMERCITY, CONTACTPERSON, PHONE, EMAIL, QUOTLINENO, TIMETRANS, SALESTRANSNO
FROM         dbo.QUOTATIONS
WHERE     (QUOTLINENO = 1)
GO

DROP VIEW VIEW_PRODUCTCLAIMCODES
GO

CREATE VIEW [dbo].[VIEW_PRODUCTCLAIMCODES] AS 

SELECT     dbo.PRODUCTS.PRODUCTCODE, dbo.PRODUCTS.BARCODE, dbo.PRODUCTS.PRODUCTNAME, dbo.PRODUCTS.ALT_PRODUCTNAME, dbo.PRODUCTS.FORMCODE, dbo.PRODUCTS.STRENGTH, 
                      dbo.PRODUCTNMMASCODES.OTHERNMMASCODE AS NAMASCODE, dbo.PRODUCTS.SUPPLIERCODE, dbo.PRODUCTS.MANUCODE, dbo.PRODUCTS.DEPTID, dbo.PRODUCTS.LOCATIONID, dbo.PRODUCTS.DRUGSCHEDULE, 
                      dbo.PRODUCTS.THERACODE, dbo.PRODUCTS.COUNSELLINGCODE, dbo.PRODUCTS.UNITOFMEASURE, dbo.PRODUCTS.TAXCODE, dbo.PRODUCTS.MARKUP, dbo.PRODUCTS.REORDERLEVEL, 
                      dbo.PRODUCTS.REORDERQUANTITY, dbo.PRODUCTS.DISCONTINUEDON, dbo.PRODUCTS.USERID, dbo.PRODUCTS.TIMETRANS, 
                      dbo.PRODUCTS.ITEMLINKCODE, dbo.PRODUCTNMMASCODES.MEDICALAIDCODE, S.PACKSIZE
FROM         dbo.PRODUCTS INNER JOIN
                      dbo.PRODUCTNMMASCODES ON dbo.PRODUCTS.PRODUCTCODE = dbo.PRODUCTNMMASCODES.PRODUCTCODE INNER JOIN STOCKMAST S
		      ON dbo.PRODUCTS.PRODUCTCODE = S.PRODUCTCODE
                      
union 

SELECT     dbo.PRODUCTS.PRODUCTCODE, dbo.PRODUCTS.BARCODE, dbo.PRODUCTS.PRODUCTNAME, dbo.PRODUCTS.ALT_PRODUCTNAME, dbo.PRODUCTS.FORMCODE, dbo.PRODUCTS.STRENGTH, 
                      dbo.PRODUCTS.NAMASCODE, dbo.PRODUCTS.SUPPLIERCODE, dbo.PRODUCTS.MANUCODE, dbo.PRODUCTS.DEPTID, dbo.PRODUCTS.LOCATIONID, dbo.PRODUCTS.DRUGSCHEDULE, 
                      dbo.PRODUCTS.THERACODE, dbo.PRODUCTS.COUNSELLINGCODE, dbo.PRODUCTS.UNITOFMEASURE, dbo.PRODUCTS.TAXCODE, dbo.PRODUCTS.MARKUP, dbo.PRODUCTS.REORDERLEVEL, 
                      dbo.PRODUCTS.REORDERQUANTITY, dbo.PRODUCTS.DISCONTINUEDON, dbo.PRODUCTS.USERID, dbo.PRODUCTS.TIMETRANS, 
                      dbo.PRODUCTS.ITEMLINKCODE, '1' as MEDICALAIDCODE, S.PACKSIZE
FROM         dbo.PRODUCTS INNER JOIN STOCKMAST S ON dbo.PRODUCTS.PRODUCTCODE = S.PRODUCTCODE
WHERE dbo.PRODUCTS.PRODUCTCODE not in (select productcode from dbo.PRODUCTNMMASCODES) AND dbo.PRODUCTS.NAMASCODE <>''
GO

DROP VIEW [dbo].[VIEW_LABELSPRINTED]
GO


CREATE VIEW [dbo].[VIEW_LABELSPRINTED]
AS
SELECT     LT.LABELPRINTID, LT.LABELID, L.PRODUCTNAME, 0 AS INGREDIENTID, LT.NOOFPACKS AS LABELSPRINTED, LT.OTCPRODUCTCODE AS OTCPOSCODE, 
                      0 AS DISPPRODCODE, LT.OTCPACKSIZE, 0 AS DISPPACKSIZE, L.POSLOCATIONID, 0 AS DISPLOCATIONID, 0 AS INGREDIENTQUANTITY, LT.PREPACKQUANTITY, 
                      LT.USERID, LT.TIMETRANS AS TRANSDATE
FROM         LABELSPRINTEDTRANSACTIONS LT INNER JOIN
                      LABELS L ON LT.LABELID = L.LABELID
WHERE     LT.DISPPRODUCTCODE = 0
UNION
SELECT     LT.LABELPRINTID, LT.LABELID, P.PRODUCTNAME, 1 AS INGREDIENTID, LT.NOOFPACKS AS LABELSPRINTED, 0 AS OTCPOSCODE, 
                      LT.DISPPRODUCTCODE AS DISPPRODCODE, 0 AS OTCPACKSIZE, LT.DISPPACKSIZE, 0 AS POSLOCATIONID, LT.DISPLOCATIONID, 
                      LT.INGREDIENTQUANTITY, LT.PREPACKQUANTITY, LT.USERID, LT.TIMETRANS AS TRANSDATE
FROM         
                      LABELSPRINTEDTRANSACTIONS LT INNER JOIN PRODUCTS P ON LT.DISPPRODUCTCODE = P.PRODUCTCODE
WHERE     LT.OTCPRODUCTCODE = 0

GO

DROP VIEW [dbo].[VIEW_ALLTRANSACTIONS]
GO

CREATE VIEW [dbo].[VIEW_ALLTRANSACTIONS]
AS
SELECT     TI.BRANCHNO, TT.TRANSNO, TI.TILLNO, TI.ACCOUNTID, 1 AS PRODUCTCODE, 1 AS PACKSIZE, 1 AS QUANTITY, TT.TENDERTYPE AS TRANTYPE, TT.TENDERTYPE AS TENDER_TYPEID, 
                      TP.TENDERTYPE AS TENDERNAME, 0 AS COSTINFOREX, 0 AS COSTPRICE, 0 AS PRICEB4TAX, 0 AS SELLINGPRICE, TT.TRANSTOTAL, 0 AS ACC_PAYMENT, TT.DISCOUNTFACTOR, 
                      TT.DISCOUNT AS DISCOUNTAMOUNT, TT.AMOUNTTENDERED, TT.TENDEREXCHANGE, 1 AS BASECURRENCYRATE, TT.CHANGEAMOUNT, TT.TIMETRANS, 1 AS REPORTORDER, 
                      0 AS QUANTITYFREE
FROM         TRANSACTIONTOTALS TT INNER JOIN
                      VIEW_TRANSACTIONSINDEX TI ON TT.TRANSNO = TI.TRANSNO INNER JOIN
                      TRANTYPE TP ON TT.TENDERTYPE = TP.TRANTYPE
WHERE     TI.TRANTYPE not in (14, 15, 20, 22) AND TT.TENDERTYPE IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, T.ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      1 AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T.TRANTYPE = TP.TRANTYPE 
WHERE     T .TRANTYPE IN (15)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      S.TENDEREXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE INNER JOIN
                      SCRIPTHEADERS S ON T .SCRIPTNO = S.SCRIPTNO
WHERE     T .TRANTYPE = 22

UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, T.ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, D.DEFAULTTENDERTYPE AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T.ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      1 AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 1 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T.TRANTYPE = TP.TRANTYPE INNER JOIN DEBTORS D ON T.ACCOUNTID = D.ACCOUNTID
WHERE     T.TRANTYPE = 10 AND T.ACCOUNTID <> 0

UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      T .FOREXEXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE
WHERE     T .TRANTYPE NOT IN (15, 22, 10) AND T .TRANTYPE NOT IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)

GO

ALTER TABLE DAYENDTOTALS
ADD
	VERIFIEDBY INT NULL DEFAULT 0
GO
UPDATE DAYENDTOTALS SET VERIFIEDBY = 0 WHERE VERIFIEDBY IS NULL
GO

ALTER TABLE SETUP
ADD
	ALLOWDAYENDVERIFICATION BIT NULL DEFAULT 0
GO
UPDATE SETUP SET ALLOWDAYENDVERIFICATION = 0 WHERE ALLOWDAYENDVERIFICATION IS NULL
GO

ALTER TABLE SETUP
ADD
	ALLOWNDSCRIPT BIT NULL DEFAULT 0
GO
UPDATE SETUP SET ALLOWNDSCRIPT = 0 WHERE ALLOWNDSCRIPT IS NULL
GO

ALTER TABLE TRANSACTIONTOTALS
ADD
	FISCALTRANSREF nvarchar(200) NULL DEFAULT ''
GO

UPDATE TRANSACTIONTOTALS SET FISCALTRANSREF ='' WHERE FISCALTRANSREF IS NULL
GO

SP_RENAME 'CONTROLS.BPNNO' , 'TINNO'
GO
ALTER TABLE BRANCHES
ADD
	EMAILADDRESS nvarchar(100) NULL DEFAULT ''
GO
UPDATE BRANCHES SET EMAILADDRESS = '' WHERE EMAILADDRESS IS NULL
GO
ALTER TABLE TRANSACTIONTOTALS
ADD	
	REVMAXDEVICEID nvarchar(30) NULL DEFAULT '',
	FISCALDAYCOUNT nvarchar(30) NULL DEFAULT '',
	ZIMRAINVOICENO nvarchar(30) NULL DEFAULT '',
	ZIMRARECEIPTNO nvarchar(30) NULL DEFAULT ''
GO
UPDATE TRANSACTIONTOTALS SET REVMAXDEVICEID = '', FISCALDAYCOUNT = '', ZIMRAINVOICENO = '', ZIMRARECEIPTNO = '' WHERE ZIMRAINVOICENO IS NULL
GO
ALTER TABLE TRANSACTIONTOTALS
ADD	
	RETURNREASON nvarchar(40) NULL DEFAULT ''
GO
UPDATE TRANSACTIONTOTALS SET RETURNREASON = '' WHERE RETURNREASON IS NULL
GO

ALTER TABLE TAXCODES
ADD	
	TAXSTATUS nvarchar(5) NULL DEFAULT ''
GO

ALTER TABLE TAXCODES
ADD CONSTRAINT PK_TAXCODES PRIMARY KEY(TAXCODE)
GO

UPDATE TAXCODES SET TAXSTATUS ='NV' WHERE TAXCODE = 1 AND TAXSTATUS IS NULL
GO

UPDATE TAXCODES SET TAXSTATUS ='VT' WHERE TAXCODE = 2  AND TAXSTATUS IS NULL
GO

INSERT INTO TAXCODES(TAXCODE, TAXAMOUNT, FISCALVATCODE, TIMETRANS, TAXSTATUS) VALUES ('3', '0', '2', GETDATE(), 'EX')
GO

ALTER TABLE CUSTOMERS
ADD
	VATREGNO NVARCHAR(20) NULL DEFAULT '',
	TINNO NVARCHAR(20) NULL DEFAULT ''
GO

UPDATE CUSTOMERS SET VATREGNO = '', TINNO = '' WHERE VATREGNO IS NULL
GO
CREATE VIEW VIEW_POSUSERS
AS
SELECT     USERID, USERNAME, FULLNAME, Position, PASSWORD, SUPERVISOR, GROUPID, USERRANKING, FISCALUSERID, FISCALPASSWORD, CREATEDBY, DEACTIVATED, TIMETRANS, 
                      PASSWORDEXPIRY
FROM         SYSTEMUSERS

GO
ALTER TABLE PATIENTDEPENDENTS
	ADD UNPAIDSCRIPTS MONEY NULL DEFAULT 0
GO
	
UPDATE PATIENTDEPENDENTS SET UNPAIDSCRIPTS = 0 WHERE UNPAIDSCRIPTS IS NULL
GO

ALTER TABLE SETUP
ADD
	SHOWPRICEONDELIVERYLABEL BIT NULL DEFAULT 0
GO

UPDATE SETUP SET SHOWPRICEONDELIVERYLABEL =0 WHERE SHOWPRICEONDELIVERYLABEL IS NULL
GO

DROP VIEW VIEW_ALLTRANSACTIONS
GO

CREATE VIEW VIEW_ALLTRANSACTIONS
AS
SELECT     TI.BRANCHNO, TT.TRANSNO, TI.TILLNO, TI.ACCOUNTID, 1 AS PRODUCTCODE, 1 AS PACKSIZE, 1 AS QUANTITY, TT.TENDERTYPE AS TRANTYPE, TT.TENDERTYPE AS TENDER_TYPEID, 
                      TP.TENDERTYPE AS TENDERNAME, 0 AS COSTINFOREX, 0 AS COSTPRICE, 0 AS PRICEB4TAX, 0 AS SELLINGPRICE, TT.TRANSTOTAL, 0 AS ACC_PAYMENT, TT.DISCOUNTFACTOR, 
                      TT.DISCOUNT AS DISCOUNTAMOUNT, TT.AMOUNTTENDERED, TT.TENDEREXCHANGE, 1 AS BASECURRENCYRATE, TT.CHANGEAMOUNT, TT.TIMETRANS, 1 AS REPORTORDER, 
                      0 AS QUANTITYFREE
FROM         TRANSACTIONTOTALS TT INNER JOIN
                      VIEW_TRANSACTIONSINDEX TI ON TT.TRANSNO = TI.TRANSNO INNER JOIN
                      TRANTYPE TP ON TT.TENDERTYPE = TP.TRANTYPE
WHERE     TI.TRANTYPE not in (14, 15, 20, 22, 10) AND TT.TENDERTYPE IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, T.ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      1 AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T.TRANTYPE = TP.TRANTYPE 
WHERE     T .TRANTYPE IN (15)
UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      S.TENDEREXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE INNER JOIN
                      SCRIPTHEADERS S ON T .SCRIPTNO = S.SCRIPTNO
WHERE     T .TRANTYPE IN(10, 22) AND T.ACCOUNTID <> 0  AND T.TENDER_TYPE NOT IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)

UNION
SELECT     T .BRANCHNO, T .TRANSNO, T .TILLNO, 0 AS ACCOUNTID, T .PRODUCTCODE, T .PACKSIZE, T .QUANTITY, T .TRANTYPE, 0 AS TENDER_TYPEID, TP.DESCRIPTION AS TENDERNAME, 
                      T .COSTINFOREX, T .COSTPRICE, T .PRICEB4TAX, T .SELLINGPRICE, T .LINETOTAL AS TRANSTOTAL, T .ACC_PAYMENT, 0 AS DISCOUNTFACTOR, T .DISCOUNTAMOUNT, 0 AS AMOUNTTENDERED, 
                      T .FOREXEXCHANGERATE AS TENDEREXCHANGE, T .BASECURRENCYRATE, 0 AS CHANGEAMOUNT, T .TIMETRANS, 2 AS REPORTORDER, T .QUANTITYFREE
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TP ON T .TRANTYPE = TP.TRANTYPE
WHERE     T .TRANTYPE NOT IN (15, 22, 10) AND T .TRANTYPE NOT IN
                          (SELECT     TENDERTYPE
                            FROM          TENDERS)
GO


ALTER TABLE BRANCHES
ADD
	ORGANIZATIONNAME NVARCHAR(60) NULL DEFAULT ''
GO

UPDATE BRANCHES SET ORGANIZATIONNAME = '' WHERE ORGANIZATIONNAME IS NULL
GO

insert into TRANTYPE(TRANTYPE, DESCRIPTION, CATEGORYID, MODULE, TENDERTYPE, TENDERVALUE, SEEKAUTHORIZATION, GETHOLDERDETAILS, TENDEREXCHANGE, 
                      PRINTCOPIES, ISFOREX, MAXDISCOUNT, ROUNDING, REQUESTREF, ISDEFAULTTENDER)
VALUES('50','PRRICECHANGEUP', '8', 'SYS','PRICECHANGEUP','0','0','0','1','0','0','0','0','0','0')
go

insert into TRANTYPE(TRANTYPE, DESCRIPTION, CATEGORYID, MODULE, TENDERTYPE, TENDERVALUE, SEEKAUTHORIZATION, GETHOLDERDETAILS, TENDEREXCHANGE, 
                      PRINTCOPIES, ISFOREX, MAXDISCOUNT, ROUNDING, REQUESTREF, ISDEFAULTTENDER)
VALUES('51','PRRICECHANGEDOWN', '9', 'SYS','PRICECHANGEDOWN','0','0','0','1','0','0','0','0','0','0')
go


DROP VIEW VIEW_ZREADTRANSACTIONS
GO

CREATE VIEW VIEW_ZREADTRANSACTIONS
AS
SELECT     T.BranchNo, T.TRANSNO, T.ACCOUNTID, T.TRANTYPE, T.DOCNO, T.TILLNO
FROM         TRANSACTIONS T INNER JOIN
                      TRANTYPE TY ON T.TRANTYPE = TY.TRANTYPE
WHERE     (TY.CATEGORYID IN (1, 2, 5, 6))
GROUP BY T.TRANSNO, T.ACCOUNTID, T.TRANTYPE, T.DOCNO, T.BranchNo, T.TILLNO


GO


DROP VIEW VIEW_ZREADVALUES
GO

CREATE VIEW VIEW_ZREADVALUES
AS
SELECT     VIEW_ZREADTRANSACTIONS.BranchNo, VIEW_ZREADTRANSACTIONS.TRANSNO, VIEW_ZREADTRANSACTIONS.ACCOUNTID, VIEW_ZREADTRANSACTIONS.TRANTYPE, 
                      VIEW_ZREADTRANSACTIONS.DOCNO, TRANSACTIONTOTALS.TRANSTOTAL AS LINETOTAL, TRANSACTIONTOTALS.DISCOUNTFACTOR, TRANSACTIONTOTALS.DISCOUNT, 
                      TRANSACTIONTOTALS.AMOUNTTENDERED, TRANSACTIONTOTALS.TENDEREXCHANGE, TRANSACTIONTOTALS.USERID, TRANSACTIONTOTALS.TIMETRANS, 
                      TENDERS.TENDERNAME, TRANTYPE.CATEGORYID, TRANSACTIONTOTALS.TENDERTYPE AS TENDER_TYPEID, TRANSACTIONTOTALS.CHANGEAMOUNT, 
                      VIEW_ZREADTRANSACTIONS.TILLNO
FROM         VIEW_ZREADTRANSACTIONS INNER JOIN
                      TRANSACTIONTOTALS ON VIEW_ZREADTRANSACTIONS.TRANSNO = TRANSACTIONTOTALS.TRANSNO INNER JOIN
                      TRANTYPE ON VIEW_ZREADTRANSACTIONS.TRANTYPE = TRANTYPE.TRANTYPE INNER JOIN
                      TENDERS ON TRANSACTIONTOTALS.TENDERTYPE = TENDERS.TENDERTYPE

GO